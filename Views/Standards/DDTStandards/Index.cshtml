@using ServiceManual.Services
@model DdtStandardsResponse

@{
    ViewData["Title"] = "DDT Standards";
    var standards = Model?.Data ?? new List<DdtStandardDto>();
    var categories = ViewBag.Categories as List<string> ?? new List<string>();
    var search = ViewBag.Search as string;
    var category = ViewBag.Category as string;
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
    var totalPages = ViewBag.TotalPages as int? ?? 1;
    var totalRecords = ViewBag.TotalRecords as int? ?? 0;
    var errorMessage = ViewBag.ErrorMessage as string;
}

@section Breadcrumbs {
                    <li class="govuk-breadcrumbs__list-item">
                        <a class="govuk-breadcrumbs__link" href="/">Home</a>
                    </li>
                    <li class="govuk-breadcrumbs__list-item">
                        <a class="govuk-breadcrumbs__link" href="@Url.Action("Index", "Standards")">Standards</a>
                    </li>
                    <li class="govuk-breadcrumbs__list-item" aria-current="page">DDT Standards</li>
}

@section Masthead {
    <div class="content-page-hero">
        <div class="govuk-width-container">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <h1 class="govuk-heading-xl">DDT Standards</h1>
                    <p class="govuk-body-l">
                        Digital, data and technology standards to support good service delivery in DfE.
                    </p>
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="govuk-width-container">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
                    <h2 class="govuk-error-summary__title" id="error-summary-title">
                        There is a problem
                    </h2>
                    <div class="govuk-error-summary__body">
                        <ul class="govuk-list govuk-error-summary__list">
                            <li>
                                <a href="#standards-content">@errorMessage</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<div class="govuk-width-container" id="standards-content">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-quarter">
            <div class="moj-filter">
                <div class="moj-filter__header">
                    <div class="moj-filter__header-title">
                        <h2 class="govuk-heading-m">Filter</h2>
                    </div>
                    <div class="moj-filter__header-action"></div>
                </div>

                <div class="moj-filter__content" style="padding: 20px;">
                    @if (!string.IsNullOrEmpty(search) || !string.IsNullOrEmpty(category))
                    {
                        <div class="moj-filter__tags">
                            <h3 class="govuk-heading-s govuk-!-margin-bottom-2">Active filters</h3>
                            <ul class="moj-filter-tags">
                                @if (!string.IsNullOrEmpty(search))
                                {
                                    <li>
                                        <a class="moj-filter__tag" href="@Url.Action("Index", "DDTStandards", new { category = category })">
                                            <span>Search: @search</span>
                                        </a>
                                    </li>
                                }
                                @if (!string.IsNullOrEmpty(category))
                                {
                                    <li>
                                        <a class="moj-filter__tag" href="@Url.Action("Index", "DDTStandards", new { search = search })">
                                            <span>Category: @category</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </div>
                        <div style="margin-bottom: 20px;"></div>
                    }

                    <form method="get" action="@Url.Action("Index", "DDTStandards")" class="moj-filter__form">
                        <div class="govuk-form-group">
                            <label class="govuk-label govuk-label--s" for="search">
                                Search
                            </label>
                            <input class="govuk-input" id="search" name="search" type="text" value="@search" placeholder="Search standards...">
                        </div>

                        <div class="govuk-form-group">
                            <label class="govuk-label govuk-label--s" for="category">
                                Category
                            </label>
                            <select class="govuk-select" id="category" name="category">
                                <option value="">All categories</option>
                                @foreach (var cat in categories)
                                {
                                    <option value="@cat" selected="@(category == cat)">@cat</option>
                                }
                            </select>
                        </div>

                        <div class="govuk-form-group" style="margin-top: 20px;">
                            <button type="submit" class="govuk-button" data-module="govuk-button">
                                Apply filters
                            </button>
                            <a href="@Url.Action("Index", "DDTStandards")" class="govuk-button govuk-button--secondary" data-module="govuk-button" style="margin-left: 10px;">
                                Clear filters
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="govuk-grid-column-one-half">
            @if (standards.Any())
            {
                <div class="govuk-body govuk-!-margin-bottom-4">
                    <p class="govuk-body-s">Showing @standards.Count of @totalRecords standards</p>
                </div>

                <ul class="govuk-list">
                    @foreach (var standard in standards)
                    {
                        <li class="govuk-!-margin-bottom-6 govuk-!-padding-bottom-4" style="border-bottom: 1px solid #b1b4b6;">
                            <h3 class="govuk-heading-s govuk-!-margin-bottom-2">
                                <a href="@Url.Action("Details", "DDTStandards", new { slug = standard.Slug })" class="govuk-link">@standard.Title</a>
                            </h3>
                            
                            @if (!string.IsNullOrEmpty(standard.Summary))
                            {
                                var maxLength = 200;
                                string truncatedSummary;
                                if (standard.Summary.Length > maxLength)
                                {
                                    truncatedSummary = standard.Summary.Substring(0, maxLength);
                                    // Find the last space before the limit to avoid cutting words
                                    var lastSpace = truncatedSummary.LastIndexOf(' ');
                                    if (lastSpace > maxLength * 0.8) // Only use word boundary if it's not too far back
                                    {
                                        truncatedSummary = truncatedSummary.Substring(0, lastSpace);
                                    }
                                    truncatedSummary += "…";
                                }
                                else
                                {
                                    truncatedSummary = standard.Summary;
                                }
                                <p class="govuk-body" style="font-size: 1rem;">@truncatedSummary</p>
                            }
                        </li>
                    }
                </ul>

                @if (totalPages > 1)
                {
                    <nav class="govuk-pagination" role="navigation" aria-label="Results">
                        @if (currentPage > 1)
                        {
                            <div class="govuk-pagination__prev">
                                <a class="govuk-link govuk-pagination__link" href="@Url.Action("Index", "DDTStandards", new { search = search, category = category, page = currentPage - 1 })" rel="prev">
                                    <svg class="govuk-pagination__icon govuk-pagination__icon--prev" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                                        <path d="m6.5938-0.0078125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.7426-4.5111 4.725-4.4062z"></path>
                                    </svg>
                                    <span class="govuk-pagination__link-title">Previous</span>
                                </a>
                            </div>
                        }

                        <ul class="govuk-pagination__list">
                            @for (int i = 1; i <= totalPages; i++)
                            {
                                @if (i == currentPage)
                                {
                                    <li class="govuk-pagination__item govuk-pagination__item--current">
                                        <a class="govuk-link govuk-pagination__link" href="#" aria-label="Page @i" aria-current="page">
                                            @i
                                        </a>
                                    </li>
                                }
                                else if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                                {
                                    <li class="govuk-pagination__item">
                                        <a class="govuk-link govuk-pagination__link" href="@Url.Action("Index", "DDTStandards", new { search = search, category = category, page = i })" aria-label="Page @i">
                                            @i
                                        </a>
                                    </li>
                                }
                                else if (i == currentPage - 3 || i == currentPage + 3)
                                {
                                    <li class="govuk-pagination__item govuk-pagination__item--ellipsis">
                                        …
                                    </li>
                                }
                            }
                        </ul>

                        @if (currentPage < totalPages)
                        {
                            <div class="govuk-pagination__next">
                                <a class="govuk-link govuk-pagination__link" href="@Url.Action("Index", "DDTStandards", new { search = search, category = category, page = currentPage + 1 })" rel="next">
                                    <span class="govuk-pagination__link-title">Next</span>
                                    <svg class="govuk-pagination__icon govuk-pagination__icon--next" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                                        <path d="m8.107-0.0078125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
                                    </svg>
                                </a>
                            </div>
                        }
                    </nav>
                }
            }
            else
            {
                <div class="govuk-body">
                    <p>No standards found.</p>
                    @if (!string.IsNullOrEmpty(search) || !string.IsNullOrEmpty(category))
                    {
                        <p><a href="@Url.Action("Index", "DDTStandards")" class="govuk-link">Clear filters</a> to see all standards.</p>
                    }
                </div>
            }
        </div>

        <div class="govuk-grid-column-one-quarter" role="complementary">
            <aside class="govuk-!-margin-top-0">
                <h2 class="govuk-heading-m">More guidance</h2>
                <nav aria-label="Related guidance">
                    <ul class="govuk-list govuk-list--spaced">
                        <li>
                            <a href="https://www.gov.uk/guidance/the-technology-code-of-practice" class="govuk-link" target="_blank" rel="noopener noreferrer">
                                Technology Code of Practice (TCOP) <span class="govuk-visually-hidden">(Link opens in new tab)</span>
                            </a>
                        </li>
                      
                        <li>
                            <a href="https://apply-the-service-standard.education.gov.uk/" class="govuk-link" rel="noopener noreferrer">
                                Apply the Service Standard
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof MOJFrontend !== 'undefined' && MOJFrontend.FilterToggleButton) {
                // Create a container for the toggle button if it doesn't exist
                var filterContainer = document.querySelector('.moj-filter__header-action');
                if (filterContainer && !filterContainer.querySelector('.moj-action-bar__filter')) {
                    var toggleContainer = document.createElement('div');
                    toggleContainer.className = 'moj-action-bar__filter';
                    filterContainer.appendChild(toggleContainer);
                }
                
                var filterToggleButton = new MOJFrontend.FilterToggleButton({
                    bigModeMediaQuery: '(min-width: 48.0625em)',
                    startHidden: false,
                    toggleButton: {
                        container: document.querySelector('.moj-action-bar__filter'),
                        showText: 'Show filter',
                        hideText: 'Hide filter',
                        classes: 'govuk-button--secondary'
                    },
                    closeButton: {
                        container: document.querySelector('.moj-filter__header-action'),
                        text: 'Close'
                    },
                    filter: {
                        container: document.querySelector('.moj-filter')
                    }
                });
            }
        });
    </script>
}


